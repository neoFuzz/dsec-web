<!DOCTYPE html>
<html lang="en">
<head>
    <title>CW to threeJS</title>
</head>
<body>
<script src="./js/ds.js"></script>
<script src="./js/bootstrap.bundle.js"></script>

Example to show the creating an image in a ImageData buffer<br>
<canvas width="800" height="600" id="3dSpace"></canvas>
<script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.153.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.153.0/examples/jsm/"
        }
    }
</script>
<script type="module">

    function preloadImages(paths, callback) {
        let loaded = 0;
        paths.forEach(function (values, keys) {
            let img = new Image();
            img.src = keys;
            img.onload = onImagePreloaded;
            preImages.set(keys, img);
        });

        function onImagePreloaded() {
            loaded++;
            if (loaded === paths.length && callback) {
                callback(preImages);
            }
        }
    }

    preloadImages(preImages);
    CWSYSTEM.Global.initialize();
    import * as THREE from 'three';

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, 1.3333, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(800, 600);
    document.body.appendChild(renderer.domElement);

    let dsMain;

    const planeGeometry = new THREE.PlaneGeometry(5, 5); // Adjust the size as needed
    const texture = new THREE.TextureLoader().load('assets/images/dsectorTitle.jpg');//new THREE.CanvasTexture(imgdata); // Create the texture using ImageData
    const material = new THREE.MeshBasicMaterial({map: texture});
    const plane = new THREE.Mesh(planeGeometry, material);
    scene.add(plane);
    camera.position.z = 5; // Adjust the camera position as needed

    // Post-loading functions and processes
    document.addEventListener('DOMContentLoaded', function () {
        document.body.addEventListener("contextmenu", function (evt) {
            evt.preventDefault();
            return false;
        });
        preloadImages(preImages);

        // Set up touch buttons
        let up = document.getElementById("up");
        up.addEventListener("touchstart", () => {
            dsMain.userIOBuffer.addKeyPressedEvent(38);
        });
        up.addEventListener("touchend", () => {
            dsMain.userIOBuffer.addKeyReleasedEvent(38);
        });
        let down = document.getElementById("down");
        down.addEventListener("touchstart", () => {
            dsMain.userIOBuffer.addKeyPressedEvent(40);
        });
        down.addEventListener("touchend", () => {
            dsMain.userIOBuffer.addKeyReleasedEvent(40);
        });
        let left = document.getElementById("left");
        left.addEventListener("touchstart", () => {
            dsMain.userIOBuffer.addKeyPressedEvent(37);
        });
        left.addEventListener("touchend", () => {
            dsMain.userIOBuffer.addKeyReleasedEvent(37);
        });
        let right = document.getElementById("right");
        right.addEventListener("touchstart", () => {
            dsMain.userIOBuffer.addKeyPressedEvent(39);
        });
        right.addEventListener("touchend", () => {
            dsMain.userIOBuffer.addKeyReleasedEvent(39);
        });
        let c_w = document.getElementById("change-weapon");
        c_w.addEventListener("touchstart", () => dsMain.userIOBuffer.addKeyPressedEvent(13));
        c_w.addEventListener("touchend", () => dsMain.userIOBuffer.addKeyReleasedEvent(13));
        let f_w = document.getElementById("fire-weapon");
        f_w.addEventListener("touchstart", () => {dsMain.userIOBuffer.addKeyPressedEvent(32)});
        f_w.addEventListener("touchend", () => dsMain.userIOBuffer.addKeyReleasedEvent(32));

        dsMain = new dsector.DSMain();
        dsMain.main();

    });

    function animate() {
        requestAnimationFrame(animate);
        {
            const framePeriod = (33 / CWSYSTEM.Global.subFrames | 0);
            CWSYSTEM.Environment.advanceCycle();
            CWSYSTEM.Environment.lastFramePeriod = CWSYSTEM.Environment.currentTime() - dsMain.mainLoopStartTime;
            if (CWSYSTEM.Environment.lastFramePeriod$() < (n => n < 0 ? Math.ceil(n) : Math.floor(n))(framePeriod)) {
                // sleep?
                // framePeriod - Environment.lastFramePeriod
                CWSYSTEM.Environment.lastFramePeriod = framePeriod;
            }
            dsMain.mainLoopStartTime = CWSYSTEM.Environment.currentTime();
            dsMain.userIOBuffer.process();
            dsMain.DSReference.gui.drawWindows();
            dsector.TimedInstruction.executeInstructionsDue();
            CWSYSTEM.Environment.processButtonsAndKeysThatAreHeld();
            dsMain.DSReference.virtualScreen.update();
            if (!CWSYSTEM.Global.runState) {
                // will fix soon
            }
        }
        renderer.render(scene, camera);
    }

    CWSYSTEM.Debug.println("starting animation...");
    //animate();
</script>

</body>
</html>
